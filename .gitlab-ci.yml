# SPDX-FileCopyrightText: 2022 Ren√© de Hesselle <dehesselle@web.de>
#
# SPDX-License-Identifier: GPL-2.0-or-later

variables:
  GIT_DEPTH: 1
  GIT_SUBMODULE_STRATEGY: recursive
  WRK_DIR: /Users/Shared/work
  CCACHE_DIR: /Users/Shared/work/ccache

stages:
  - prepare
  - build
  - release

.config_matrix: &config_matrix
  - TARGET_OS: "11.3"
    RUNNER: bigsurarm
  - TARGET_OS: "10.13.4"
    RUNNER: bigsur

#----------------------------------------------------------------------- prepare

include:
  - remote: https://raw.githubusercontent.com/dehesselle/sdkchecksum/master/.gitlab-ci/verify_sdk-template.yml

verify_sdk:
  stage: prepare
  parallel:
    matrix:
      *config_matrix
  variables:
    SDKROOT: /opt/sdks/MacOSX${TARGET_OS}.sdk
  tags:
    - ${RUNNER}
  extends:
    - .verify_sdk

#------------------------------------------------------------------------- build

build:
  stage: build
  parallel:
    matrix:
      *config_matrix
  variables:
    SDKROOT: /opt/sdks/MacOSX${TARGET_OS}.sdk
  tags:
    - ${RUNNER}
  script:
    - ./build_toolset.sh
    # I hate having to remove the contents of PKG_DIR but artifact size needs
    # to stay below 1 GiB for GitLab.
    - |
      source jhb/etc/jhb.conf.sh
      find "$SRC_DIR" -mindepth 1 -maxdepth 1 -type d ! -name 'bash_d' ! -name 'gtk-mac-bundler*' ! -name 'jhb*' ! -name 'png2icns*' -exec rm -rf {} \;
      rm -rf "${BLD_DIR:?}"/*
      rm -rf "${PKG_DIR:?}"/*
      rm -rf "${TMP_DIR:?}"/*
      rm -rf "${VAR_DIR:?}"/cache/pip/*
      rm -rf "${VAR_DIR:?}"/cache/pycache/*
    - jhb/usr/bin/archive create_dmg
  after_script:
    # Cleanup is necessary for persistent runners but can be disabled for
    # debugging purposes.
    - |
      if [ ! -f "$WRK_DIR"/no_cleanup-15865869 ]; then
        rm -rf "${VER_DIR:?}"
      fi
  artifacts:
    paths:
      - mibap*.dmg

#----------------------------------------------------------------------- release

release:
  stage: release
  only:
    - tags
  image: python:3-alpine
  script:
    - pip3 install gitlab-release==5.6
    # requires PRIVATE_TOKEN with api permission
    - gitlab-release mibap*.dmg
